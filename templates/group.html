<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Group {{ group.group_id }}</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 800px; margin: 0 auto; padding: 16px; }
    .header { display: flex; gap: 12px; align-items: baseline; justify-content: space-between; }
    .left { display: flex; gap: 12px; align-items: baseline; }
    .chat-box { border: 1px solid #ccc; height: 420px; overflow-y: auto; padding: 12px; border-radius: 8px; background: #fafafa; }
    .msg { margin: 6px 0; }
    .from { font-weight: 600; margin-right: 8px; }
    form { display: flex; gap: 8px; margin-top: 12px; }
    input[type=text] { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #bbb; }
    button, .btn { padding: 10px 16px; border: 0; border-radius: 6px; background: #1e88e5; color: white; cursor: pointer; text-decoration: none; display: inline-block; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .subheading { color:#444; font-size:14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="left">
        <h2>Group {{ group.group_id }}</h2>
        <div class="subheading">Event: {{ event.event_name }}</div>
      </div>
      <a class="btn" href="/my_group">← All my groups</a>
    </div>

    <div id="chat" class="chat-box">
      {% if messages %}
        {% for m in messages %}
          <div class="msg" data-id="{{ m.messages_id }}">
            <span class="from">{{ m.sender or "Unknown" }}</span>
            <span class="text">{{ m.message_content }}</span>
            <small style="color:#666;"> — {{ m.time_stamp }}</small>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <form id="send-form" autocomplete="off">
      <input id="msg-input" type="text" maxlength="300" placeholder="Type a message…" />
      <button id="send-btn" type="submit">Send</button>
    </form>
  </div>

  <!-- Bootstrap data using data-* attributes -->
  <div id="bootstrap"
       data-group-id="{{ group.group_id }}"
       data-event-name="{{ event.event_name|e }}">
  </div>

  <script>
    const bootEl = document.getElementById('bootstrap');
    const groupId = parseInt(bootEl.dataset.groupId, 10);

    const chatEl = document.getElementById('chat');
    const formEl = document.getElementById('send-form');
    const inputEl = document.getElementById('msg-input');

    let lastId = (function () {
      const last = chatEl.querySelector('.msg:last-child');
      return last ? parseInt(last.getAttribute('data-id'), 10) : 0;
    })();

    function appendMessages(list) {
      if (!Array.isArray(list)) return;
      list.forEach(m => {
        const div = document.createElement('div');
        div.className = 'msg';
        div.dataset.id = m.id;
        div.innerHTML = `<span class="from"></span>
                         <span class="text"></span>
                         <small style="color:#666;"> — ${m.ts || ""}</small>`;
        div.querySelector('.from').textContent = m.sender || "Unknown";
        div.querySelector('.text').textContent = m.message;
        chatEl.appendChild(div);
        lastId = m.id;
      });
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function poll() {
      try {
        const url = lastId
          ? `/api/group/${groupId}/messages?since_id=${encodeURIComponent(lastId)}`
          : `/api/group/${groupId}/messages`;
        const res = await fetch(url, { credentials: 'same-origin' });
        if (res.ok) {
          const data = await res.json();
          if (data && data.length) appendMessages(data);
        }
      } catch (e) {
        // ignore transient errors
      }
    }

    // Poll every 2 seconds
    setInterval(poll, 2000);

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = inputEl.value.trim();
      if (!message) return;
      const btn = formEl.querySelector('button');
      btn.disabled = true;
      try {
        const res = await fetch(`/api/group/${groupId}/messages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message }),
          credentials: 'same-origin'
        });
        if (res.ok) {
          inputEl.value = '';
          await poll(); // show the new message immediately
        } else {
          const err = await res.json().catch(() => ({}));
          alert(err.error || 'Failed to send message');
        }
      } finally {
        btn.disabled = false;
        inputEl.focus();
      }
    });
  </script>
</body>
</html>
